#!/bin/bash

_init()
{
    exec 3>&1
}

main()
{
    local choice;

    while :
    do
      choice=$( dialog --title "[ Gluster Tools ]" --menu "Select Action"\
	  0 0 0\
	  "network" "configure network interfaces/routes" \
	  "mac-collector" "collect MACs of the client nodes" \
	  "bootdisk" "create client bootdisks" \
	  "gfdisk" "repartitioning tool" \
	  "shell" "drop into bash shell" \
	  "gconsole" "gluster console management" 2>&1 >&3) || break;

      [ "${choice}" = "network" ] && {
	  /etc/stage2/config_network.sh;
      }
      [ "${choice}" = "bootdisk" ] && {
	  if [ -f /usr/share/gluster/extensions/bootman/bootman ]
	  then
	      chmod +x /usr/share/gluster/extensions/bootman/bootman
              /usr/share/gluster/extensions/bootman/bootman
	  else
	      dialog --msgbox "Gluster stage-3 not yet loaded" 0 0
	  fi
      }
      [ "${choice}" = "gfdisk" ] && {
	  if [ -f /usr/bin/gpart ] ; then
	      gprobe > /tmp/gfdisk.spec
	      gpart -i /tmp/gfdisk.spec \
		  -c /tmp/gfdisk.cmds \
		  -d /dev/null
	      sh /tmp/gfdisk.cmds
	      rm -f /tmp/gfdisk.cmds
	      echo 
	      echo -n "Press [Enter] to continue"
	      read
	  else
	      dialog --msgbox 'Gluster stage-3 not yet loaded' 0 0
	  fi
      }
      [ "${choice}" = "shell" ] && {
	  /bin/bash --login;
      }
      [ "${choice}" = "mac-collector" ] && {
	  if [ -f /usr/bin/gpart ] ; then
	      chmod +x /usr/share/gluster/extensions/mac-collector/*
	      /usr/share/gluster/extensions/mac-collector/mac-collector
	      echo 
	      echo -n "Press [Enter] to continue"
	      read
	  else
	      dialog --msgbox 'Gluster stage-3 not yet loaded' 0 0
	  fi
      }
      [ "${choice}" = "gconsole" ] && {
	  gconsole
      }
    done      
}

_init "$@" && main "$@";
